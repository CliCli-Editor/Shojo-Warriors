# 相关文件

📦 地图
    ├── 📜 dungeon.json **副本信息**
    ├── 📜 match.json **匹配信息**
    ├── 📁 custom
    |   └── 📁 protocol
    |       └── 📜 protocol.pb **协议文件**
    └── 📁 maps
        └── 📁 <EntryMap>
            ├── 📁 custom_eca
            |   └── 📜 custom_python.py **自定义接口**
            └── 📁 script
                └── 📁 game
                    ├── 📁 network **匹配系统网络库**
                    ├── 📁 proto **匹配系统协议库**
                    ├── 📁 service **匹配系统服务**
                    ├── 📁 lib
                    |   └── 📜 bob.lua **匹配业务核心**
                    └── 📁 pub **匹配业务代码**
                        ├── 📜 pub.lua **匹配逻辑**
                        └── 📜 ui.lua **匹配界面**

你能改的文件是 `match.json`，`dungeon.json`， `pub.lua` 和 `ui.lua`，其他文件不要动

# 基本原理

将地图分为 **大厅** 与 **游戏** 2部分。

这2部分可以是不同的地图，也可以是同一个地图的不同模式。

《圣剑酒馆》地图使用了后者方案，在编辑器中可以设置2个模式：

* `1001`: 大厅模式
* `1002`: 游戏模式

`dungeon.json` 请参考《圣剑酒馆》的配置，其中第一层的key为 `level_id` （`275002142480236558774673269526863166590`），请根据自己地图的 `*.gmp` 文件名修改

`match.json` 请参考《圣剑酒馆》的配置：

* `diffuse_time`: 匹配段位放宽时间（秒），到最后一个时间会立即开局
* `level_id`：匹配成功后切换到的地图id
* `game_mode`: 匹配成功后使用的游戏模式
* `sections`: 匹配段位规则
    * `max_score`: 当队伍中所有玩家的分数均不超过此分数时应用此规则
    * `min_player_num`: 最少的真人玩家数
* `teams`: 队伍数量

当匹配成功后会，客户端会自动加载新的地图并切换到 `1002` 模式。使用 `y3.game:get_current_game_mode()` 可以获取当前的游戏模式。

> 需要注意的是，切换到新的地图后，在初始化事件中玩家还没有加入游戏。你需要通过“玩家-加入游戏”事件来初始化玩家的行为。
> 目前暂时没有办法知道玩家什么时候全部加入进来（不知道会有多少玩家进来，也不知道某个槽位是否被玩家占据），目前的解决办法是初始化后等待一段时间（10秒）再初始化，之后进不来的就不管了。

# 圣剑酒馆的流程

请查看 `pub.lua` 文件

## 初始化

首先通过 `玩家-加入游戏` 事件初始化玩家

+ 如果游戏模式是 `1001`： 启用大厅模式 `create_bob_in_game`
+ 如果游戏模式是 `1002`： 启用游戏模式 `create_bob_in_game`

## 大厅模式

+ 创建匹配核心 `create_bob()`
    * 创建匹配核心对象 `New `Bob` ()`
    * 设置 `ip`、`port`，请直接抄《圣剑酒馆》相关的代码，在本地、QA服（`qa`）、测试服（`pre`）、正式服（`prod`）使用不同的设置
    * 设置 `game_play_id`，这些之后请在群里问服务器同学（张宇）
    * 设置 `level_id`，这个从之前的 `dungeon.json` 里抄
    * 如果要单机测试，还需要伪造 `token`、`map_id`，同样需要咨询服务器同学
+ 设置状态为大厅模式 `BOB:set_in_game(false)`
+ 注册登录成功后的回调函数 `BOB:event_on('准备就绪', function () ... end)`，《圣剑酒馆》会在登录成功后初始化界面
+ 开始登录 `BOB:start()`

## 游戏模式

+ 创建匹配核心 `create_bob()`，同大厅模式
+ 设置状态为游戏模式 `BOB:set_in_game(true)`
+ 开始登录 `BOB:start()`

## 其它

《圣剑酒馆》导出了几个全局变量给ECA使用：

+ 游戏模式打完后，ECA调用 `CreateBobInLobby()` 重建大厅模式，可以在不关游戏的情况下再次匹配
+ ECA调用 `SetScore` 修改玩家的分数，只要在开始匹配前调用即可
+ `ConnectVSCode()` 由于平台调试困难，预留了后门可以在平台上调试。可以查看《Y3开发助手》`readme.md` 中的 `远程终端` 章节。

# 主要接口

具体的界面逻辑都在 `ui.lua` 中，比较繁杂，这里挑几个重点：

+ 开始匹配 `BOB:start_match(game_mode, score)` ，需要传入目标游戏模式 `1002`。目前的接口只支持传游戏模式，如果你们的方案是匹配到不同的地图中，可以联系我扩展接口。
+ 匹配成功后，平台会负责切换地图，不需要地图内进行任何操作
    * 本地测试无法切换地图
+ 从匹配完成到进入游戏有几秒的时间，这期间本地只知道匹配被取消了，但是不知道是主动取消的还是匹配成功了。并且如果用户在这几秒内再次启用了匹配，那么会在之后再匹配成功一次从第一场对局中拉到第二场对局中。目前的临时处理方案是：
    * 如果点击过开始匹配，但是没有点击过取消匹配，那么当发现匹配被取消后会被视为“启动中”状态，可以使用 `BOB:is_launching()` 获取这个状态，并阻止用户再次匹配。该状态会持续10秒。
    * 本地禁止了用户在匹配过程中退出队伍、加入队伍、交换队长等操作。
    * 预计下周会更新出能获取到正确的启动中状态的方法。
+ 你也可以阅读 `bob.lua` ，看那些没有被标记为 `---@private` 的接口，上面都有完备的注释。
